class window.ContraceptivesApp

  filter_keys: 
    'contraceptives-filter-0': 'residence'
    'contraceptives-filter-1': 'age'
    'contraceptives-filter-2': 'education'
    'contraceptives-filter-3': 'wealth'

  dhs_countries:
    'AFG':
      'name': 'AFIR70DT'
      'year': '2017'
    'ALB':
      'name': 'ALIR50DT'
      'year': '2008-09'
    'ARM':
      'name': 'AMIR61DT'
      'year': '2010'
    'AGO':
      'name': 'AOIR71DT'
      'year': '2015-16'
    'AZE':
      'name': 'AZIR52DT'
      'year': '2006'
    'BGD':
      'name': 'BDIR72DT'
      'year': '2014'
    'BEN':
      'name': 'BJIR51DT'
      'year': '2006'
    'BOL':
      'name': 'BOIR51DT'
      'year': '2008'
    'BDI':
      'name': 'BUIR61DT'
      'year': '2010'
    'COD':
      'name': 'CDIR61DT'
      'year': '2013-14'
    'COG':
      'name': 'CGIR60DT'
      'year': '2011-12'
    'CIV':
      'name': 'CIIR62DT'
      'year': '2011-12'
    'CMR':
      'name': 'CMIR61DT'
      'year': '2011'
    'COL':
      'name': 'COIR71DT'
      'year': '2015-16'
    'DOM':
      'name': 'DRIR61DT'
      'year': '2013'
    'EGY':
      'name': 'EGIR61DT'
      'year': '2014'
    'ETH':
      'name': 'ETIR70DT'
      'year': '2016'
    'GHA':
      'name': 'GHIR72DT'
      'year': '2014'
    'GMB':
      'name': 'GMIR60DT'
      'year': '2013'
    'GIN':
      'name': 'GNIR62DT'
      'year': '2012'
    'GTM':
      'name': 'GUIR71DT'
      'year': '2014-15'
    'GUY':
      'name': 'GYIR5IDT'
      'year': '2009'
    'HND':
      'name': 'HNIR62DT'
      'year': '2011-12'
    'HTI':
      'name': 'HTIR61DT'
      'year': '2012'
    'IND':
      'name': 'IAIR71DT'
      'year': '2015'
    'IDN':
      'name': 'IDIR63DT'
      'year': '2012'
    'JOR':
      'name': 'JOIR6CDT'
      'year': '2012'
    'KEN':
      'name': 'KEIR70DT'
      'year': '2014'
    'KHM':
      'name': 'KHIR73DT'
      'year': '2014'
    'LBR':
      'name': 'LBIR6ADT'
      'year': '2013'
    'LSO':
      'name': 'LSIR71DT'
      'year': '2014'
    'MAR':
      'name': 'MAIR43DT'
      'year': '2003-04'
    'MDG':
      'name': 'MDIR51DT'
      'year': '2008-09'
    'MLI':
      'name': 'MLIR53DT'
      'year': '2006'
    'MMR':
      'name': 'MMIR71DT'
      'year': '2016'
    'MWI':
      'name': 'MWIR7HDT'
      'year': '2015-16'
    'MOZ':
      'name': 'MZIR62DT'
      'year': '2011'
    'NGA':
      'name': 'NGIR6ADT'
      'year': '2013'
    'NER':
      'name': 'NIIR51DT'
      'year': '2006'
    'NAM':
      'name': 'NMIR61DT'
      'year': '2013'
    'NPL':
      'name': 'NPIR7HDT'
      'year': '2016'
    'PER':
      'name': 'PEIR6IDT'
      'year': '2012'
    'PHL':
      'name': 'PHIR61DT'
      'year': '2013'
    'PAK':
      'name': 'PKIR61DT'
      'year': '2012-13'
    'RWA':
      'name': 'RWIR70DT'
      'year': '2015'
    'SLE':
      'name': 'SLIR61DT'
      'year': '2013'
    'SEN':
      'name': 'SNIR6DDT'
      'year': '2012-13'
    'STP':
      'name': 'STIR50DT'
      'year': '2008'
    'SWZ':
      'name': 'SZIR51DT'
      'year': '2006'
    'TCD':
      'name': 'TDIR71DT'
      'year': '2014-15'
    'TGO':
      'name': 'TGIR61DT'
      'year': '2013-14'
    'TJK':
      'name': 'TJIR61DT'
      'year': '2012'
    'TLS':
      'name': 'TLIR61DT'
      'year': '2009-10'
    'TZA':
      'name': 'TZIR7HDT'
      'year': '2015-16'
    'UGA':
      'name': 'UGIR60DT'
      'year': '2011'
    'ZMB':
      'name': 'ZMIR51DT'
      'year': '2007'
    'ZWE':
      'name': 'ZWIR71DT'
      'year': '2015'

  sentences: 
    'ALB': 'La marcha atrás es el primer método anticonceptivo de Albania. Además, se trata del segundo país donde existe mayor oposición de la propia mujer, la pareja o la religión a tomar anticonceptivos.'
    'ARG': '<a href="https://www.clarin.com/sociedad/campana-ley-aborto-comenzo-2005-proyecto-presento-veces_0_BJvdi0nPz.html">Unas cinco mil mujeres marcharon en febrero de 2018 frente al Congreso argentino para pedir la legalización del aborto.</a>'
    'AUS': '<a href="http://www.abc.net.au/news/health/2017-07-22/natural-methods-of-contraception-on-the-rise-in-australia/8683346">Muchos australianos están volviendo a utilizar métodos tradicionales de anticoncepción, según un estudio de Monash University.</a>'
    'BEL': '<a href="http://www.dutchnews.nl/news/archives/2017/03/she-decides-foundation-brings-in-e181m-for-family-planning-campaign/">Bélgica donó 10 millones de euros para la campaña <i>She Decides</i>, lanzada por el Gobierno holandés para contrarrestar la retirada de fondos para planificación familiar de Trump.</a>'
    'BOL': '<a href="https://www.efe.com/efe/america/sociedad/la-vergüenza-y-el-estigma-de-pedir-preservativos-en-bolivia//20000013-3265652">Farmacias de Bolivia implementaron códigos secretos para pedir preservativos y evitar el estigma de comprar estos anticonceptivos.</a>'
    'COL': '<a href="https://www.nytimes.com/2017/01/07/world/asia/after-one-child-policy-outrage-at-chinas-offer-to-remove-iuds.html">El Gobierno chino ofrece la retirada gratuita de DIUs después de la política del hijo único.</a>'
    'SLV': '<a href="https://www.theguardian.com/global-development-professionals-network/gallery/2017/may/26/reproductive-rights-zika-women-el-salvador-in-pictures">El Salvador es el único país del mundo donde abortar está penado con cárcel.</a>'
    'FIN': '<a href="http://www.helsinkitimes.fi/finland/finland/news/domestic/15271-helsinki-to-offer-year-s-worth-of-contraceptive-pills-to-under-25-year-olds.html">El ayuntamiento de Helsinki proporciona anticonceptivos de manera gratuita a los jóvenes menores de 25 años.</a>'
    'FRA': '<a href="https://www.connexionfrance.com/French-news/French-women-opt-for-alternatives-as-Pill-use-drops">El uso de las pastillas anticonceptivas se ha reducido en Francia desde 2010.</a>'
    'GMB': 'En Gambia, muchas mujeres utilizan un método tradicional que consiste en atar a la cintura una cuerda, una rama, o un papelito con o sin frases del Corán.'
    'DEU': '<a href="http://www.dw.com/en/free-prescribed-contraception-for-low-earners/a-38161577">Un proyecto alemán facilita anticonceptivos de forma gratuita a mujeres de más de 20 años con ingresos bajos.</a>'
    'GTM': '<a href="http://buff.ly/2taYwco">La religión influye en la educación sexual de los jóvenes guatemaltecos.</a>'
    'ISR': 'En los sectores judíos más ortodoxos, solo pueden usarse los anticonceptivos si el rabino da su permiso a la mujer.'
    'JPN': 'Japón, aunque se encuentra en el grupo de países con renta alta, es la excepción: las necesidades no cubiertas con anticonceptivos está al nivel de países con rentas bajas.'
    'PRK': 'El 95% de mujeres que utilizan anticonceptivos en Corea del Norte han elegido el DIU. Se trata del mayor porcentaje de uso a nivel mundial.'
    'NLD': '<a href="http://www.dutchnews.nl/news/archives/2017/03/she-decides-foundation-brings-in-e181m-for-family-planning-campaign/">El gobierno holandés lanza el proyecto <i>She Decides</i> para contrarrestar la retirada de fondos para planificación familiar de Trump.</a>'
    'PER': '<a href="https://interactive.quipu-project.com/#/es/quipu/intro">En la época de los 90, durante el gobierno de Fujimori, más de 250.000 mujeres fueron esterilizadas sin su consentimiento.</a>'
    'PHL': '<a href="https://www.theguardian.com/global-development/2017/jul/10/how-bitter-herbs-and-botched-abortions-kill-three-women-a-day-in-the-philippines"> En un país donde el aborto del está prohibido, tres mujeres mueren al día por complicaciones derivadas de intervenciones ilegales.</a>'
    'POL': '<a href="https://www.amnesty.org/en/latest/news/2017/06/poland-emergency-contraception-restrictions-catastrophic-for-women-and-girls/">El Gobierno polaco da un paso atrás y se convierte en el único país de la Unión Europea donde la pastilla del día después está sujeta a prescripción.</a>'
    'SSD': '<a href="https://www.theguardian.com/global-development/2017/may/25/every-year-i-give-birth-war-driving-contraception-crisis-sudan-nuba-mountains">La guerra en Sudán está creando una crisis en el acceso a anticonceptivos.</a>'
    'ESP': '<a href="http://cadenaser.com/emisora/2017/09/19/radio_madrid/1505842932_131031.html">Madrid es la única comunidad que no financia anticonceptivos con sus fondos.</a>'
    'TUR': '<a href="http://www.bbc.com/news/world-europe-36413097">Erdogan declara que la planificación familiar no es para los musulmanes.</a>'
    'UGA': '<a href="https://www.newvision.co.ug/new_vision/news/1458882/uganda-facing-150-million-condom-shortfall">En 2017, el Ministerio de Salud de Uganda declaraba un desabastecimiento de 150 millones de preservativos masculinos.</a>'
    'GBR': '<a href=https://www.theguardian.com/world/2018/jan/29/ireland-to-greenlight-referendum-on-abortion-law-reform">En Irlanda es ilegal abortar a no ser que haya un riesgo real de salud para la madre.</a>'
    'USA': '<a href="https://www.nytimes.com/2018/01/18/us/health-care-office-abortion-contraception.html">Trump da a los médicos libertad para negarse a realizar procedimientos en contra de sus creencias religiosas, como el aborto.</a>'
    'VEN': '<a href="http://www.bbc.com/mundo/noticias-america-latina-42635412">La escasez y el precio elevado de los anticonceptivos en Venezuela influye en el aumento de embarazos no deseados.</a>'
    'ZMB': '<a href="https://www.ideo.org/project/diva-centres">Un proyecto en Zambia  une la manicura y los anticonceptivos.</a>'


  constructor: (data_use, data_unmetneeds, data_reasons, user_country, methods_keys, methods_names, methods_dhs_names, reasons_names, reasons_dhs_names) ->

    @data = 
      use:        data_use
      unmetneeds: data_unmetneeds
      reasons:    data_reasons

    @methodsKeys      = methods_keys
    @methodsNames     = methods_names
    @methodsDHSNames  = methods_dhs_names
    @reasonsNames     = reasons_names
    @reasonsDHSNames  = reasons_dhs_names

    @$app = $('#contraceptives-app')

    @$app.find('.select-country')
      .select2()
      .change @onSelectCountry
      .val user_country.code
      .trigger 'change'

    @$app.find('.contraceptives-app-filters .btn').click @onSelectFilter

    @$app.css('opacity',1)


  onSelectCountry: (e) =>
    @country_code = $(e.target).val()

    use           = null
    method        = null
    method_value  = null
    unmetneeds    = null
    reason        = null
    reason_value  = null

    # hide filters & clear active btns
    @$app.find('.contraceptives-app-filters').hide().find('.btn').removeClass('active')
    # hide filters results
    $('.contraceptives-filter').hide()

    if @dhs_countries[@country_code]
      # set data year
      @$app.find('#contraceptives-app-data-year').html @dhs_countries[@country_code].year
      # load country dhs data
      d3.csv $('body').data('baseurl')+'/data/contraceptives-reasons/'+@dhs_countries[@country_code].name+'_all.csv', (error, data) =>
        d = data[0]
        # setup data
        @setAppItemData @$app, 100*d.using_modern_method/d.n, @methodsDHSNames[d.most_popular_method], 100*d.most_popular_method_n/d.n, 100*d.with_unmet_needs/d.n, @reasonsDHSNames[d.most_popular_reason], 100*d.most_popular_reason_n/d.n_reasons
        # show filters
        @$app.find('.contraceptives-app-filters').show()
    else
      # set data year
      @$app.find('#contraceptives-app-data-year').html '2015-16'
      # Use
      countryUse = @data.use.filter (d) => d.code == @country_code
      if countryUse and countryUse[0]
        if countryUse[0]['Any modern method'] != '0'
          use           = countryUse[0]['Any modern method']
        country_methods = @methodsKeys.map (key, i) => {'name': @methodsNames[i], 'value': +countryUse[0][key]}
        country_methods = country_methods.sort (a,b) -> b.value-a.value
        method          = country_methods[0].name
        method_value    = country_methods[0].value
      # Unmetneeds
      countryUnmetneeds = @data.unmetneeds.filter (d) => d.code == @country_code
      if countryUnmetneeds and countryUnmetneeds[0]
        # use survey data if available, use estimated if not
        unmetneeds = if countryUnmetneeds[0]['survey'] then countryUnmetneeds[0]['survey'] else countryUnmetneeds[0]['estimated'] 
      # Reasons
      countryReasons = @data.reasons.filter (d) => d.code == @country_code
      if countryReasons and countryReasons[0]
        reasons      = Object.keys(@reasonsNames).map (reason) => {'name': @reasonsNames[reason], 'value': +countryReasons[0][reason]}
        reasons      = reasons.sort (a,b) -> b.value-a.value
        reason       = reasons[0].name
        reason_value = reasons[0].value
      # setup data
      @setAppItemData @$app, use, method, method_value, unmetneeds, reason, reason_value


  onSelectFilter: (e) =>
    e.preventDefault()
    if @filter != $(e.target).attr('href').substring(1)
      $('html, body').animate {scrollTop: @$app.find('.contraceptives-app-filters').offset().top-15}, 400
      @$app.find('.contraceptives-app-filters .btn').removeClass('active')
      $target = $(e.target).addClass('active')
      @filter = $target.attr('href').substring(1)
      $('.contraceptives-filter').hide()
      @filterEl = $('#'+@filter).show()
      # load csv file
      d3.csv $('body').data('baseurl')+'/data/contraceptives-reasons/'+@dhs_countries[@country_code].name+'_'+@filter_keys[@filter]+'.csv', (error, data) =>
        if data
          data.forEach (d) =>
            @setAppItemData @filterEl.find('#'+@filter+'-'+d.id), 100*d.using_modern_method/d.n, @methodsDHSNames[d.most_popular_method], 100*d.most_popular_method_n/d.n, 100*d.with_unmet_needs/d.n, @reasonsDHSNames[d.most_popular_reason], 100*d.most_popular_reason_n/d.n_reasons


  setAppItemData: ($el, use, method, method_value, unmetneeds, reason, reason_value) ->

    #console.log 'setAppItemData', $el, use, method, method_value, unmetneeds, reason, reason_value

    if use
      $el.find('.contraceptives-app-data-use').html Math.round(+use)+'%'
      $el.find('.contraceptives-app-use').show()
    else
      $el.find('.contraceptives-app-use').hide()

    if method
      $el.find('.contraceptives-app-data-main-method').html method
      $el.find('.contraceptives-app-data-main-method-value').html Math.round(+method_value)+'%'
      $el.find('.contraceptives-app-method').show()
    else
      $el.find('.contraceptives-app-method').hide()

    if unmetneeds
      $el.find('.contraceptives-app-data-unmetneeds').html Math.round(+unmetneeds)+'%'
      $el.find('.contraceptives-app-unmetneeds').show()
    else
      $el.find('.contraceptives-app-unmetneeds').hide()

    if reason
      $el.find('.contraceptives-app-data-reason').html reason
      $el.find('.contraceptives-app-data-reason-value').html Math.round(+reason_value)+'%'
      $el.find('.contraceptives-app-reason').show()
    else
      $el.find('.contraceptives-app-reason').hide()
